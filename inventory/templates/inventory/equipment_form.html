{% extends "layouts/base.html" %}
{% load static %}

{% block title %}{% if object %}Редактирование оборудования{% else %}Создание оборудования{% endif %}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/tom-select.css' %}">
    <style>
        /* убираем “вторую рамку” — прячем оригинальный select после инициализации TomSelect */
        select.ts-hidden-accessible {
            display: none !important;
        }
    </style>
{% endblock extrastyle %}

{% block content %}
    <div class="pc-container">
        <div class="pc-content">

            <div class="page-header">
                <div class="page-block">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="page-header-title">
                                <h5 class="m-b-10">
                                    {% if object %}Редактирование оборудования{% else %}Создание оборудования{% endif %}
                                </h5>
                            </div>
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item"><a href="{% url 'index' %}">Главная</a></li>
                                <li class="breadcrumb-item"><a
                                        href="{% url 'inventory:equipment_list' %}">Оборудование</a></li>
                                <li class="breadcrumb-item" aria-current="page">
                                    {% if object %}Редактирование{% else %}Создание{% endif %}
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <a class="btn btn-light" href="{% url 'inventory:equipment_list' %}">Отмена</a>
                        </div>
                    </div>
                </div>
            </div>

            <form method="post" novalidate>
                {% csrf_token %}

                <div class="card">
                    <div class="card-body">

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <div class="row g-3">
                            <div class="col-6">
                                <div class="row g-3">
                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0"
                                                   for="{{ form.equipment_type.id_for_label }}">{{ form.equipment_type.label }}</label>
                                            <a class="btn btn-sm-light-primary d-flex align-items-center gap-2"
                                               href="{% url 'inventory:equipmenttype_create' %}?next={{ request.get_full_path|urlencode }}">
                                                <i class="ti ti-plus"></i> Тип
                                            </a>
                                        </div>
                                        {{ form.equipment_type }}
                                        {% if form.equipment_type.errors %}
                                            <div class="text-danger small">{{ form.equipment_type.errors|striptags }}</div>{% endif %}
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label mb-1"
                                               for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="text-danger small">{{ form.status.errors|striptags }}</div>{% endif %}
                                    </div>

                                    <div class="col-md-12">
                                        <label class="form-label mb-1"
                                               for="{{ form.organization.id_for_label }}">{{ form.organization.label }}</label>
                                        {{ form.organization }}
                                        {% if form.organization.errors %}
                                            <div class="text-danger small">{{ form.organization.errors|striptags }}</div>{% endif %}
                                    </div>

                                    <div class="col-md-12">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <label class="form-label mb-0"
                                                   for="{{ form.assigned_to.id_for_label }}">{{ form.assigned_to.label }}</label>
                                            <a class="btn btn-sm-light-primary d-flex align-items-center gap-2"
                                               id="add-employee-btn"
                                               href="{% url 'directory:employee_create' %}?next={{ request.path|urlencode }}&org_id={{ form.organization.value|default_if_none:'' }}">
                                                <i class="ti ti-plus"></i> Сотрудник
                                            </a>
                                        </div>
                                        {{ form.assigned_to }}
                                        {% if form.assigned_to.errors %}
                                            <div class="text-danger small">{{ form.assigned_to.errors|striptags }}</div>{% endif %}
                                        <div class="form-text">Сотрудники подгружаются по выбранной организации</div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label"
                                           for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                                    {{ form.name }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">{{ form.name.errors|striptags }}</div>{% endif %}
                                </div>

                                <div class="col-12">
                                    <label class="form-label"
                                           for="{{ form.model.id_for_label }}">{{ form.model.label }}</label>
                                    {{ form.model }}
                                    {% if form.model.errors %}
                                        <div class="invalid-feedback d-block">{{ form.model.errors|striptags }}</div>{% endif %}
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.serial_number.id_for_label }}">{{ form.serial_number.label }}</label>
                                        {{ form.serial_number }}
                                        {% if form.serial_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.serial_number.errors|striptags }}</div>{% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.inventory_number.id_for_label }}">{{ form.inventory_number.label }}</label>
                                        {{ form.inventory_number }}
                                        {% if form.inventory_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.inventory_number.errors|striptags }}</div>{% endif %}
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.pc_number.id_for_label }}">{{ form.pc_number.label }}</label>
                                        {{ form.pc_number }}
                                        {% if form.pc_number.errors %}
                                            <div class="invalid-feedback d-block">{{ form.pc_number.errors|striptags }}</div>{% endif %}
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.commissioning_date.id_for_label }}">{{ form.commissioning_date.label }}</label>
                                        {{ form.commissioning_date }}
                                        {% if form.commissioning_date.errors %}
                                            <div class="invalid-feedback d-block">{{ form.commissioning_date.errors|striptags }}</div>{% endif %}
                                    </div>
                                </div>


                            </div>
                            <div class="col-6">
                                <div id="computer-fields" class="row g-3 mt-1">
                                    <div class="col-md-12">
                                        <label class="form-label"
                                               for="{{ form.cpu.id_for_label }}">{{ form.cpu.label }}</label>
                                        {{ form.cpu }}
                                        {% if form.cpu.errors %}
                                            <div class="text-danger small">{{ form.cpu.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label"
                                               for="{{ form.ram_gb.id_for_label }}">{{ form.ram_gb.label }}</label>
                                        {{ form.ram_gb }}
                                        {% if form.ram_gb.errors %}
                                            <div class="text-danger small">{{ form.ram_gb.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label"
                                               for="{{ form.storageHDD_gb.id_for_label }}">{{ form.storageHDD_gb.label }}</label>
                                        {{ form.storageHDD_gb }}
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label"
                                               for="{{ form.storageSDD_gb.id_for_label }}">{{ form.storageSDD_gb.label }}</label>
                                        {{ form.storageSDD_gb }}
                                    </div>
                                </div>

                                <div id="print-fields" class="row g-3 mt-1">
                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.print_format.id_for_label }}">{{ form.print_format.label }}</label>
                                        {{ form.print_format }}
                                        {% if form.print_format.errors %}
                                            <div class="text-danger small">{{ form.print_format.errors|striptags }}</div>{% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"
                                               for="{{ form.print_mode.id_for_label }}">{{ form.print_mode.label }}</label>
                                        {{ form.print_mode }}
                                        {% if form.print_mode.errors %}
                                            <div class="text-danger small">{{ form.print_mode.errors|striptags }}</div>{% endif %}
                                    </div>
                                </div>


                                <label class="form-label"
                                       for="{{ form.specs.id_for_label }}">{{ form.specs.label }}</label>
                                {{ form.specs }}
                                {% if form.specs.errors %}
                                    <div class="invalid-feedback d-block">{{ form.specs.errors|striptags }}</div>{% endif %}
                            </div>

                        </div>

                    </div>

                    <div class="card-footer text-end">
                        <button class="btn btn-primary" type="submit">Сохранить</button>
                        <a class="btn btn-light" href="{% url 'inventory:equipment_list' %}">Отмена</a>
                    </div>
                </div>
            </form>

        </div>
    {{ equipmenttype_meta|json_script:"equipmenttype-meta" }}
    </div>
{% endblock content %}

{% block extra_js %}
    {{ block.super }}
    <script src="{% static 'plugins/tom-select.complete.min.js' %}"></script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const orgEl = document.getElementById("id_organization");
            const empEl = document.getElementById("id_assigned_to");
            const btn = document.getElementById("add-employee-btn");

            if (!orgEl || !empEl) return;
            if (!orgEl || !btn) return;

            // чтобы не было конфликтов рамок Bootstrap и TomSelect
            orgEl.classList.remove("form-select", "form-control");
            empEl.classList.remove("form-select", "form-control");

            // защита от повторной инициализации
            if (orgEl.tomselect || empEl.tomselect) return;

            const endpoint = "{% url 'inventory:ajax_employees_by_org' %}";
            const base = btn.getAttribute("href").split("&org_id=")[0];

            const orgTS = new TomSelect(orgEl, {
                create: false,
                allowEmptyOption: true,
                placeholder: "Выберите организацию"
            });

            const empTS = new TomSelect(empEl, {
                create: false,
                allowEmptyOption: true,
                placeholder: "— сначала выберите организацию —",
                valueField: "id",
                labelField: "name",
                searchField: ["name", "department"],
                preload: true,
                render: {
                    option: (item, escape) => {
                        const dept = item.department ? ` <span class="text-muted">(${escape(item.department)})</span>` : "";
                        return `<div>${escape(item.name)}${dept}</div>`;
                    },
                    item: (item, escape) => `<div>${escape(item.name)}</div>`
                },
                load: (query, callback) => {
                    const orgId = orgEl.value;
                    if (!orgId) return callback();

                    const url = endpoint
                        + "?organization_id=" + encodeURIComponent(orgId)
                        + "&q=" + encodeURIComponent(query || "");

                    fetch(url, {headers: {"X-Requested-With": "XMLHttpRequest"}})
                        .then(r => r.json())
                        .then(data => callback((data && data.results) ? data.results : []))
                        .catch(() => callback());
                }
            });

            function reloadEmployees() {
                empTS.clear(true);
                empTS.clearOptions();
                empTS.addOption({id: "", name: "— не закреплять —"});
                empTS.refreshOptions(false);
                empTS.load(""); // перезагрузка по выбранной организации
            }

            orgTS.on("change", reloadEmployees);

            // если организация уже выбрана (например, при ошибках валидации) — подгрузим сразу
            if (orgEl.value) reloadEmployees();

            function sync() {
                const orgId = orgEl.value || "";
                btn.setAttribute("href", base + "&org_id=" + encodeURIComponent(orgId));
                btn.classList.toggle("disabled", !orgId);
                btn.setAttribute("aria-disabled", orgId ? "false" : "true");
            }

            orgEl.addEventListener("change", sync);
            sync();
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const metaEl = document.getElementById("equipmenttype-meta");
            if (!metaEl) return;

            const byId = new Map(JSON.parse(metaEl.textContent || "[]").map(x => [String(x.id), x.category]));
            const etEl = document.getElementById("id_equipment_type");
            const comp = document.getElementById("computer-fields");
            const prn = document.getElementById("print-fields");
            if (!etEl || !comp || !prn) return;

            function sync() {
                const cat = byId.get(String(etEl.value || "")) || "other";
                comp.style.display = (cat === "computer") ? "" : "none";
                prn.style.display = (cat === "print") ? "" : "none";
            }

            etEl.addEventListener("change", sync);
            sync();
        });
    </script>
{% endblock extra_js %}